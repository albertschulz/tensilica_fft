table SINWAVE 16 512 {
      0,    201,    402,    603,    804,   1005,   1206,   1406,
   1607,   1808,   2009,   2209,   2410,   2610,   2811,   3011,
   3211,   3411,   3611,   3811,   4011,   4210,   4409,   4608,
   4807,   5006,   5205,   5403,   5601,   5799,   5997,   6195,
   6392,   6589,   6786,   6982,   7179,   7375,   7571,   7766,
   7961,   8156,   8351,   8545,   8739,   8932,   9126,   9319,
   9511,   9703,   9895,  10087,  10278,  10469,  10659,  10849,
  11038,  11227,  11416,  11604,  11792,  11980,  12166,  12353,
  12539,  12724,  12909,  13094,  13278,  13462,  13645,  13827,
  14009,  14191,  14372,  14552,  14732,  14911,  15090,  15268,
  15446,  15623,  15799,  15975,  16150,  16325,  16499,  16672,
  16845,  17017,  17189,  17360,  17530,  17699,  17868,  18036,
  18204,  18371,  18537,  18702,  18867,  19031,  19194,  19357,
  19519,  19680,  19840,  20000,  20159,  20317,  20474,  20631,
  20787,  20942,  21096,  21249,  21402,  21554,  21705,  21855,
  22004,  22153,  22301,  22448,  22594,  22739,  22883,  23027,
  23169,  23311,  23452,  23592,  23731,  23869,  24006,  24143,
  24278,  24413,  24546,  24679,  24811,  24942,  25072,  25201,
  25329,  25456,  25582,  25707,  25831,  25954,  26077,  26198,
  26318,  26437,  26556,  26673,  26789,  26905,  27019,  27132,
  27244,  27355,  27466,  27575,  27683,  27790,  27896,  28001,
  28105,  28208,  28309,  28410,  28510,  28608,  28706,  28802,
  28897,  28992,  29085,  29177,  29268,  29358,  29446,  29534,
  29621,  29706,  29790,  29873,  29955,  30036,  30116,  30195,
  30272,  30349,  30424,  30498,  30571,  30643,  30713,  30783,
  30851,  30918,  30984,  31049,
  31113,  31175,  31236,  31297,
  31356,  31413,  31470,  31525,  31580,  31633,  31684,  31735,
  31785,  31833,  31880,  31926,  31970,  32014,  32056,  32097,
  32137,  32176,  32213,  32249,  32284,  32318,  32350,  32382,
  32412,  32441,  32468,  32495,  32520,  32544,  32567,  32588,
  32609,  32628,  32646,  32662,  32678,  32692,  32705,  32717,
  32727,  32736,  32744,  32751,  32757,  32761,  32764,  32766,
  32767,  32766,  32764,  32761,  32757,  32751,  32744,  32736,
  32727,  32717,  32705,  32692,  32678,  32662,  32646,  32628,
  32609,  32588,  32567,  32544,  32520,  32495,  32468,  32441,
  32412,  32382,  32350,  32318,  32284,  32249,  32213,  32176,
  32137,  32097,  32056,  32014,  31970,  31926,  31880,  31833,
  31785,  31735,  31684,  31633,  31580,  31525,  31470,  31413,
  31356,  31297,  31236,  31175,  31113,  31049,  30984,  30918,
  30851,  30783,  30713,  30643,  30571,  30498,  30424,  30349,
  30272,  30195,  30116,  30036,  29955,  29873,  29790,  29706,
  29621,  29534,  29446,  29358,  29268,  29177,  29085,  28992,
  28897,  28802,  28706,  28608,  28510,  28410,  28309,  28208,
  28105,  28001,  27896,  27790,  27683,  27575,  27466,  27355,
  27244,  27132,  27019,  26905,  26789,  26673,  26556,  26437,
  26318,  26198,  26077,  25954,  25831,  25707,  25582,  25456,
  25329,  25201,  25072,  24942,  24811,  24679,  24546,  24413,
  24278,  24143,  24006,  23869,  23731,  23592,  23452,  23311,
  23169,  23027,  22883,  22739,  22594,  22448,  22301,  22153,
  22004,  21855,  21705,  21554,  21402,  21249,  21096,  20942,
  20787,  20631,  20474,  20317,  20159,  20000,  19840,  19680,
  19519,  19357,  19194,  19031,  18867,  18702,  18537,  18371,
  18204,  18036,  17868,  17699,  17530,  17360,  17189,  17017,
  16845,  16672,  16499,  16325,  16150,  15975,  15799,  15623,
  15446,  15268,  15090,  14911,  14732,  14552,  14372,  14191,
  14009,  13827,  13645,  13462,  13278,  13094,  12909,  12724,
  12539,  12353,  12166,  11980,  11792,  11604,  11416,  11227,
  11038,  10849,  10659,  10469,  10278,  10087,   9895,   9703,
   9511,   9319,   9126,   8932,   8739,   8545,   8351,   8156,
   7961,   7766,   7571,   7375,   7179,   6982,   6786,   6589,
   6392,   6195,   5997,   5799,   5601,   5403,   5205,   5006,
   4807,   4608,   4409,   4210,   4011,   3811,   3611,   3411,
   3211,   3011,   2811,   2610,   2410,   2209,   2009,   1808,
   1607,   1406,   1206,   1005,    804,    603,    402,    201
}

function [15:0] get_sin_value ([9:0] idx)
{
	// correct_idx = idx - 512
	wire [9:0] correct_idx = TIEadd(idx, ~12'h200, 1'b1);
	
	wire [15:0] sinvalue = SINWAVE[correct_idx];
	
	wire [15:0] neg_sin_value = TIEadd(16'b0, ~sinvalue, 1'b1);
	
	assign get_sin_value = TIEmux(idx[9], SINWAVE[idx], neg_sin_value);
}

operation GET_SIN_VALUE {in AR idx, out AR sin_value} {}
{
	assign sin_value = get_sin_value(idx);
}

operation FFT_CALC_TWIDDLE_FACTOR {in AR j, in BR inverse, in BR shift, out AR twiddle} {}
{
	wire [9:0] idx = TIEadd(j, 256, 1'b0);
	wire [15:0]	wr = get_sin_value(idx);
	wire [15:0] wi = TIEadd(16'b0, ~get_sin_value(j[9:0]), 1'b1);
	
	wire [15:0] x = TIEmux(inverse, wi, TIEadd(16'b0, ~wi, 1'b1));
	
	wire [15:0] y = TIEmux(shift, wr, {1{wr[15]}, wr[15:1]});
	wire [15:0] z = TIEmux(shift, x, {1{x[15]}, x[15:1]});
	
	assign twiddle = {y, z};
}

operation FFT_REVERSE_BITS {in AR d, in AR size, out AR reversed_data} {}
{
    assign reversed_data = {
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9], d[10]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9], d[10], d[11]),
        TIEmux(size[3:0], 1'b0, 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9], d[10], d[11], d[12]),
        TIEmux(size[3:0], 1'b0, 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9], d[10], d[11], d[12], d[13]),
        TIEmux(size[3:0], 1'b0, d[0], d[1], d[2], d[3], d[4], d[5], d[6], d[7], d[8], d[9], d[10], d[11], d[12], d[13], d[14])
    };
}

function [15:0] FixedSub ([15:0] a, [15:0] b)
{
	assign FixedSub = TIEadd(a, ~b, 1'b1);
}

function [15:0] FixedMul ([15:0] a, [15:0] b)
{
	wire [31:0] d = TIEmul(a, b, 1'b1);
	assign FixedMul = d[30:15];
}

regfile vec4x16 64 4 vrf

function [15:0] real ([31:0] value)
{
	assign real = value[31:16];
}

function [15:0] imag ([31:0] value)
{
	assign imag = value[15:0];
}

function [63:0] calc_butterfly ([31:0] even, [31:0] odd, [31:0] twiddle, [0:0] shift)
{
	wire [15:0] wr 		= real(twiddle);
	wire [15:0] wi 		= imag(twiddle);
	wire [15:0] even_r	= TIEmux(shift, real(even), {1{even[31]}, even[31:17]});
	wire [15:0] even_i	= TIEmux(shift, imag(even), {1{even[15]}, even[15:1]});
	
	wire [15:0] odd_r_wr	= FixedMul(wr, real(odd));
	wire [15:0] odd_i_wi	= FixedMul(wi, imag(odd));
	wire [15:0] temp_r		= FixedSub(odd_r_wr, odd_i_wi);
	
	wire [15:0] odd_r_wi = FixedMul(real(odd), wi);
	wire [15:0] odd_i_wr = FixedMul(imag(odd), wr);
	wire [15:0] temp_i 	= TIEadd(odd_r_wi, odd_i_wr, 1'b0);
	
	wire [15:0] even_out_r = TIEadd( even_r, temp_r, 1'b0);
	wire [15:0] even_out_i = TIEadd( even_i, temp_i, 1'b0);
	wire [15:0] odd_out_r  = FixedSub(even_r, temp_r); 
	wire [15:0] odd_out_i  = FixedSub(even_i, temp_i); 
	
	wire [31:0] even_out 		= {even_out_r, even_out_i};
	wire [31:0] odd_out			= {odd_out_r, odd_out_i};
	
	assign calc_butterfly = {odd_out, even_out};
}

// Upper 16 Bits:Real Part; lower 16 Bits are the imag part
operation FFT_CALC_BUTTERFLY {in AR even, in AR odd, in AR twiddle, in BR shift, out vec4x16 odd_even_out} {}
{
	assign odd_even_out = calc_butterfly(even, odd, twiddle, shift);
}

regfile vect8x16 128 8 v2rf

operation FFT_CALC_2_BUTTERFLIES {in vec4x16 even, in vec4x16 odd, in AR tw, in BR shift, out vect8x16 odd_even_out} {}
{
	wire [31:0] even1 	= even[63:32];
	wire [31:0] even2 	= even[31:0];
	
	wire [31:0] odd1	= odd[63:32];
	wire [31:0] odd2	= odd[31:0];
	
	// result = {odd, even}
	wire [63:0] result1 = calc_butterfly(even1, odd1, tw, shift);
	wire [63:0] result2 = calc_butterfly(even2, odd2, tw, shift);
	
	assign odd_even_out = {result1, result2};
}

state BUTTERFLY_RESULTS 256 256'b0 add_read_write

operation FFT_CALC_4_BUTTERFLIES_FROM_STATES {in AR twiddle, in BR shift} {in QR, in FR, in QI, in FI, out BUTTERFLY_RESULTS}
{
	// result = {odd, even}
	wire [63:0] result1 = calc_butterfly({QR[63:48],QI[63:48]}, {FR[63:48],FI[63:48]}, twiddle, shift);
	wire [63:0] result2 = calc_butterfly({QR[47:32],QI[47:32]}, {FR[47:32],FI[47:32]}, twiddle, shift);
	wire [63:0] result3 = calc_butterfly({QR[31:16],QI[31:16]}, {FR[31:16],FI[31:16]}, twiddle, shift);
	wire [63:0] result4 = calc_butterfly({QR[15:0 ],QI[15:0 ]}, {FR[15:0 ],FI[15:0 ]}, twiddle, shift);
	
	assign BUTTERFLY_RESULTS = {result1, result2, result3, result4};
}

operation STORE_REAL {in AR *addr, in AR offset}{out VAddr, out MemDataOut128, in BUTTERFLY_RESULTS}
{
	assign VAddr = addr + {offset[30:0], 1'b0};
	
	// result = {odd, even}
	wire [63:0] result1 = BUTTERFLY_RESULTS[255:192];
	wire [63:0] result2 = BUTTERFLY_RESULTS[191:128];
	wire [63:0] result3 = BUTTERFLY_RESULTS[127:64];
	wire [63:0] result4 = BUTTERFLY_RESULTS[63 :0];
	
	wire [15:0] result1_even_real 	= result1[31:16];
	wire [15:0] result1_odd_real	= result1[63:48];
	
	wire [15:0] result2_even_real 	= result2[31:16];
	wire [15:0] result2_odd_real	= result2[63:48];
	
	wire [15:0] result3_even_real 	= result3[31:16];
	wire [15:0] result3_odd_real	= result3[63:48];
	
	wire [15:0] result4_even_real 	= result4[31:16];
	wire [15:0] result4_odd_real	= result4[63:48];
	
	assign MemDataOut128 = {result4_odd_real, result4_even_real,
							result3_odd_real, result3_even_real,
							result2_odd_real, result2_even_real,
							result1_odd_real, result1_even_real};
}

operation STORE_IMAG {in AR *addr, in AR offset}{out VAddr, out MemDataOut128, in BUTTERFLY_RESULTS}
{
	assign VAddr = addr + {offset[30:0], 1'b0};
	
	// result = {odd, even}
	wire [63:0] result1 = BUTTERFLY_RESULTS[255:192];
	wire [63:0] result2 = BUTTERFLY_RESULTS[191:128];
	wire [63:0] result3 = BUTTERFLY_RESULTS[127:64];
	wire [63:0] result4 = BUTTERFLY_RESULTS[63 :0];
	
	wire [15:0] result1_even_imag 	= result1[15:0];
	wire [15:0] result1_odd_imag	= result1[47:32];
	
	wire [15:0] result2_even_imag 	= result2[15:0];
	wire [15:0] result2_odd_imag	= result2[47:32];
	
	wire [15:0] result3_even_imag 	= result3[15:0];
	wire [15:0] result3_odd_imag	= result3[47:32];
	
	wire [15:0] result4_even_imag 	= result4[15:0];
	wire [15:0] result4_odd_imag	= result4[47:32];
	
	assign MemDataOut128 = {result4_odd_imag, result4_even_imag,
							result3_odd_imag, result3_even_imag,
							result2_odd_imag, result2_even_imag,
							result1_odd_imag, result1_even_imag};
}

schedule FFT_CALC_BUTTERFLY_sched {FFT_CALC_BUTTERFLY} 
{
	def odd_even_out 2;
}

state QR 64 64'b0 add_read_write
state FR 64 64'b0 add_read_write
state QI 64 64'b0 add_read_write
state FI 64 64'b0 add_read_write

operation LOAD_REAL {in AR *addr, in AR offset}{out VAddr, in MemDataIn128, out QR, out FR}
{
	assign VAddr =  addr + {offset[30:0], 1'b0};
	wire [15:0]FR4 = MemDataIn128[127:112];
	wire [15:0]FR3 = MemDataIn128[95:80];
	wire [15:0]FR2 = MemDataIn128[63:48];
	wire [15:0]FR1 = MemDataIn128[31:16];
	assign FR = {FR1, FR2, FR3, FR4};
	
	wire [15:0]QR4 = MemDataIn128[111:96];
	wire [15:0]QR3 = MemDataIn128[79:64];
	wire [15:0]QR2 = MemDataIn128[47:32];
	wire [15:0]QR1 = MemDataIn128[15:0];
	assign QR = {QR1, QR2, QR3, QR4};
}

operation LOAD_IMAG {in AR *addr, in AR offset}{out VAddr, in MemDataIn128, out QI, out FI}
{
	assign VAddr =  addr + {offset[30:0], 1'b0};
	wire [15:0]FI4 = MemDataIn128[127:112];
	wire [15:0]FI3 = MemDataIn128[95:80];
	wire [15:0]FI2 = MemDataIn128[63:48];
	wire [15:0]FI1 = MemDataIn128[31:16];
	assign FI = {FI1, FI2, FI3, FI4};
	
	wire [15:0]QI4 = MemDataIn128[111:96];
	wire [15:0]QI3 = MemDataIn128[79:64];
	wire [15:0]QI2 = MemDataIn128[47:32];
	wire [15:0]QI1 = MemDataIn128[15:0];
	assign QI = {QI1, QI2, QI3, QI4};
}

format flix64 64 {slot_0, slot_1, slot_2}
slot_opcodes slot_0 {LOAD_REAL, STORE_REAL, LOAD_IMAG, STORE_IMAG}
slot_opcodes slot_1 {NOP}
slot_opcodes slot_2 {LOAD_REAL, STORE_REAL, LOAD_IMAG, STORE_IMAG}

// function [127:0] fft_shuffle ()